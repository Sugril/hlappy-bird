<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flappy Bird Game</title>
    <style>
        canvas {
            border: 1px solid black;
            display: block;
            margin: 0 auto;
            touch-action: none;
            width: 100%;
            max-width: 600px;
            height: auto;
        }
        .instructions {
            text-align: center;
            margin: 10px;
            font-family: Arial, sans-serif;
            color: #333;
        }
    </style>
</head>
<body>
    <div id="characterSelect" style="text-align: center; margin: 20px;">
        <h2>Choose Your Hero</h2>
        <div style="display: flex; justify-content: center; gap: 20px;">
            <div onclick="selectCharacter('./wzj.png')" style="cursor: pointer;">
                <img src="./wzj.png" style="width: 100px; height: 100px;">
                <p>老爷爷</p>
            </div>
            <div onclick="selectCharacter('./david.png')" style="cursor: pointer;">
                <img src="./david.png" style="width: 100px; height: 100px;">
                <p>Marc</p>
            </div>
        </div>
    </div>

    <div id="gameContainer" style="display: none;">
        <div class="instructions">Press SPACE or Touch Screen to Jump</div>
        <canvas id="gameCanvas"></canvas>
    </div>

    <div id="vipEndScreen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
        <div style="position: relative; top: 50%; transform: translateY(-50%); background: white; margin: 0 auto; padding: 20px; max-width: 500px; border-radius: 15px; text-align: center;">
            <h2>菜就多练！</h2>
            <div id="characterAnimation" style="margin: 20px auto;"></div>
            <div id="finalScore" style="font-size: 24px; margin: 10px;"></div>
            <div id="schoolRecord" style="font-size: 20px; margin: 10px; color: #FF4081;"></div>
            <div id="funnyMessage" style="font-size: 18px; margin: 10px; color: #666;"></div>
            <button onclick="restartGame()" style="padding: 10px 20px; font-size: 18px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;">再来一局</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let WINDOW_WIDTH = 0;
        let WINDOW_HEIGHT = 0;
        const GRAVITY = 0.25;
        let PIPE_WIDTH = 0;
        let PIPE_GAP = 0;
        let BIRD_WIDTH = 0;
        let BIRD_HEIGHT = 0;

        const flapSoundWu = new Audio('./flap_wu.mp3');
        const flapSoundDavid = new Audio('./flap_david.wav');
        const scoreSound = new Audio('./score.mp3');
        const hitSound = new Audio('./hit.mp3');
        const endSoundWu = new Audio('./wu_end.mp3');
        const endSoundDavid = new Audio('./david_end.mp3');
        let currentFlapSound;

        flapSoundWu.volume = 0.5;
        flapSoundDavid.volume = 0.5;
        scoreSound.volume = 0.5;
        hitSound.volume = 0.5;
        endSoundWu.volume = 0.5;
        endSoundDavid.volume = 0.5;

        function preloadSounds() {
            flapSoundWu.load();
            flapSoundDavid.load();
            scoreSound.load();
            hitSound.load();
            endSoundWu.load();
            endSoundDavid.load();
        }

        function playSound(sound) {
            try {
                sound.currentTime = 0;
                sound.play().catch(error => console.log("Sound play failed:", error));
            } catch (error) {
                console.log("Sound error:", error);
            }
        }

        const birdImage = new Image();
        let imageLoaded = false;

        const bgMusic = new Audio('bgm.mp3');
        bgMusic.loop = true;

        document.addEventListener('DOMContentLoaded', function() {
            bgMusic.play().catch(() => {
                document.addEventListener('click', () => {
                    bgMusic.play();
                }, { once: true });
            });
        });

        function selectCharacter(imagePath) {
            bgMusic.play().catch(error => console.log('Auto-play prevented'));
            
            if (imagePath.includes('wzj.png')) {
                currentFlapSound = flapSoundWu;
            } else if (imagePath.includes('david.png')) {
                currentFlapSound = flapSoundDavid;
            }
            
            document.getElementById('characterSelect').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';
            
            birdImage.src = imagePath;
            birdImage.onerror = function() {
                console.error('Error loading image. Falling back to rectangle');
                imageLoaded = true;
                initializeAndStartGame();
            };
            birdImage.onload = function() {
                imageLoaded = true;
                const aspectRatio = birdImage.width / birdImage.height;
                bird.width = BIRD_HEIGHT * aspectRatio;
                bird.height = BIRD_HEIGHT;
                initializeAndStartGame();
            };
        }

        function initializeAndStartGame() {
            gameActive = true;
            pipes = [];
            score = 0;
            birdMovement = 0;
            resizeGame();
            bird.y = WINDOW_HEIGHT / 2;
            gameLoop();
        }

        let birdMovement = 0;
        let gameActive = true;
        let score = 0;
        let highScore = 0;
        let pipes = [];

        let bird = {
            x: 0,
            y: 0,
            width: 0,
            height: 0
        };

        const pipeTexts = ['每', '一', '个', '孩', '子', '都', '是', '独', '一', '无', '二', '的', '研', '究', '学', '生'];
        let currentTextIndex = 0;

        function createPipe() {
            const pipeGapPosition = Math.random() * (WINDOW_HEIGHT - PIPE_GAP - 100) + 50;
            
            pipes.push({
                x: WINDOW_WIDTH,
                y: 0,
                width: PIPE_WIDTH,
                height: pipeGapPosition,
                passed: false,
                text: pipeTexts[currentTextIndex],
                textVisible: true
            });

            pipes.push({
                x: WINDOW_WIDTH,
                y: pipeGapPosition + PIPE_GAP,
                width: PIPE_WIDTH,
                height: WINDOW_HEIGHT - pipeGapPosition - PIPE_GAP,
                passed: false
            });

            currentTextIndex = (currentTextIndex + 1) % pipeTexts.length;
        }

        function drawPipes() {
            pipes.forEach(pipe => {
                ctx.fillStyle = '#2ecc71';
                ctx.fillRect(pipe.x, pipe.y, pipe.width, pipe.height);

                if (pipe.text && pipe.textVisible && pipe.y === 0) {
                    ctx.save();
                    ctx.fillStyle = '#FFD700';
                    ctx.font = 'bold 30px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    const textX = pipe.x + pipe.width / 2;
                    const textY = pipe.height + PIPE_GAP / 2;
                    ctx.fillText(pipe.text, textX, textY);
                    ctx.restore();
                }
            });
        }

        const funnyMessages = {
            'wzj.png': [
                "吴校长说：你这个年纪上课睡得着觉？",
                "吴校长说：下次我一定飞得更高！",
                "吴校长说：看来我的数学没白教！"
            ],
            'david.png': [
                "Mark says: Not bad at all!",
                "Mark says: Let's try one more time!",
                "Mark says: One World，One Beauty!"
            ]
        };

        async function showVipEndScreen() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !user.name) {
                console.error('User not found in localStorage');
                window.location.href = '../index.html';
                return;
            }

            const vipScreen = document.getElementById('vipEndScreen');
            const characterAnimation = document.getElementById('characterAnimation');
            const finalScore = document.getElementById('finalScore');
            const schoolRecord = document.getElementById('schoolRecord');
            const funnyMessage = document.getElementById('funnyMessage');

            characterAnimation.innerHTML = `<img src="${user.character}" style="width: 80px; height: 80px; margin-top: 20px;">`;
            finalScore.innerHTML = `Final Score: ${score}`;
            schoolRecord.innerHTML = `Your School Rank: ${user.rank}`;
            funnyMessage.innerHTML = (user.character.includes('wzj.png') ? funnyMessages['wzj.png'] : funnyMessages['david.png']).join('<br>');

            vipScreen.style.display = 'block';
            endSoundWu.play().catch(() => endSoundDavid.play());
        }

        function resizeGame() {
            WINDOW_WIDTH = window.innerWidth;
            WINDOW_HEIGHT = window.innerHeight;
            canvas.width = WINDOW_WIDTH;
            canvas.height = WINDOW_HEIGHT;
            PIPE_WIDTH = Math.floor(WINDOW_WIDTH * 0.1);
            PIPE_GAP = 200;
            BIRD_WIDTH = 40;
            BIRD_HEIGHT = 40;
        }

        function updateGame() {
            if (!gameActive) return;

            birdMovement += GRAVITY;

            if (bird.y + birdMovement < 0) birdMovement = 0;
            if (bird.y + birdMovement + BIRD_HEIGHT > WINDOW_HEIGHT) {
                endGame();
                return;
            }

            bird.y += birdMovement;

            if (pipes.length === 0 || pipes[pipes.length - 1].x <= WINDOW_WIDTH - 300) {
                createPipe();
            }

            pipes.forEach(pipe => {
                pipe.x -= 2;

                if (pipe.x + pipe.width < 0) {
                    pipes.shift();
                    pipes.shift();
                }

                if (!pipe.passed && pipe.x + pipe.width < bird.x) {
                    pipe.passed = true;
                    score++;
                    scoreSound.play();
                }
            });

            drawPipes();

            ctx.fillStyle = '#FF6347';
            ctx.fillRect(bird.x, bird.y, bird.width, bird.height);

            ctx.fillStyle = '#FFF';
            ctx.font = 'bold 24px Arial';
            ctx.fillText('Score: ' + score, 30, 50);
            ctx.fillText('High Score: ' + highScore, WINDOW_WIDTH - 180, 50);
        }

        function endGame() {
            gameActive = false;
            if (score > highScore) {
                highScore = score;
            }
            showVipEndScreen();
        }

        function restartGame() {
            gameActive = true;
            pipes = [];
            score = 0;
            bird.y = WINDOW_HEIGHT / 2;
            gameLoop();
        }

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            updateGame();
            requestAnimationFrame(gameLoop);
        }

        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space') {
                birdMovement = -6;
                playSound(currentFlapSound);
            }
        });

        document.addEventListener('touchstart', function() {
            if (gameActive) {
                birdMovement = -6;
                playSound(currentFlapSound);
            }
        });

        window.addEventListener('resize', resizeGame);
    </script>
</body>
</html>
