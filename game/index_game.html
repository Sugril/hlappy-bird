<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JavaScript Flappy Bird</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: white;
        }
        canvas {
            display: block;
            margin: 0 auto;
            touch-action: none; /* Prevents default touch behaviors */
            background: white;
        }
        .instructions {
            text-align: center;
            margin: 10px;
            font-family: Arial, sans-serif;
            color: #333;
            position: absolute;
            top: 10px;
            width: 100%;
            z-index: 1;
        }
        #vipEndScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        #vipEndScreen > div {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        #characterSelect {
            text-align: center;
            margin: 20px;
        }
        #characterSelect div {
            display: inline-block;
            cursor: pointer;
            margin: 10px;
        }
        #characterSelect img {
            width: 100px;
            height: 100px;
        }
        #characterSelect p {
            margin: 5px 0 0 0;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); }
        }
    </style>
    <script>
        // Constants
        const GRAVITY = 0.25;
        const PIPE_SPEED = 2;
        const PIPE_FREQUENCY = 90; // Frames between pipe creation
        const FLAP_STRENGTH = -7;
        const PIPE_GAP = 150; // Fixed gap size

        let WINDOW_WIDTH = 0;
        let WINDOW_HEIGHT = 0;
        let PIPE_WIDTH = 0;
        let BIRD_WIDTH = 0;
        let BIRD_HEIGHT = 0;

        // Preload images and sounds
        const images = {};
        const sounds = {};
        const assetsToLoad = [
            { name: 'bird', src: './wzj.png' },
            { name: 'flapSound', src: './flap_wu.mp3' },
            { name: 'scoreSound', src: './score.mp3' },
            { name: 'hitSound', src: './hit.mp3' },
            { name: 'endSound', src: './wu_end.mp3' },
            { name: 'bgm', src: 'bgm.mp3' }
        ];

        let currentFlapSound;
        let bgMusic;

        function loadAssets() {
            assetsToLoad.forEach(asset => {
                if (asset.name.endsWith('Sound')) {
                    sounds[asset.name] = new Audio(asset.src);
                    sounds[asset.name].volume = 0.5;
                } else if (asset.name === 'bgm') {
                    bgMusic = new Audio(asset.src);
                    bgMusic.loop = true;
                    bgMusic.volume = 0.3;
                    bgMusic.play().catch(() => {
                        document.addEventListener('click', () => {
                            bgMusic.play();
                        }, { once: true });
                    });
                } else {
                    images[asset.name] = new Image();
                    images[asset.name].src = asset.src;
                }
            });
        }

        // Game state
        let gameActive = false;
        let score = 0;
        let highScore = 0;
        let pipes = [];
        let bird = { x: 0, y: 0, width: 0, height: 0, velocity: 0 };

        // Pipe texts
        const pipeTexts = [
            '每', '一', '个', '孩', '子', '都', '是', 
            '独', '一', '无', '二', '的', '研', '究', 
            '学', '生', '就', '是', '研', '究', '教', 
            '育', '世', '界', '因', '我', '而', '美', '丽'
        ];
        let currentTextIndex = 0;

        // Funny messages
        const funnyMessages = {
            'wzj.png': [
                "吴校长说：你这个年纪上课睡得着觉？",
                "吴校长说：下次我一定飞得更高！",
                "吴校长说：看来我的数学没白教！"
            ],
            'david.png': [
                "David says: Not bad at all!",
                "David says: Let's try one more time!",
                "David says: One World，One Beauty!"
            ]
        };

        // Canvas and context
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        document.body.appendChild(canvas);

        // Input handling
        function handleKeyDown(event) {
            if (event.code === 'Space') {
                flap();
                event.preventDefault();
            }
        }

        function handleClick() {
            flap();
        }

        function handleTouchStart() {
            flap();
        }

        function flap() {
            if (gameActive) {
                bird.velocity = FLAP_STRENGTH;
                playSound(currentFlapSound);
            } else {
                resetGame();
            }
        }

        // Sound handling
        function playSound(sound) {
            if (sound.currentTime) {
                sound.currentTime = 0;
            }
            sound.play().catch(() => {});
        }

        // Game loop
        function gameTick() {
            if (gameActive) {
                // Update bird position
                bird.velocity += GRAVITY;
                bird.y += bird.velocity;

                // Update pipes
                pipes.forEach(pipe => {
                    pipe.x -= PIPE_SPEED;
                });

                // Remove passed pipes
                pipes = pipes.filter(pipe => pipe.x + PIPE_WIDTH > 0);

                // Create new pipes
                if (pipes.length === 0 || pipes[pipes.length - 1].x < WINDOW_WIDTH - PIPE_FREQUENCY) {
                    createPipe();
                }

                // Check for collisions
                if (bird.y + bird.height >= WINDOW_HEIGHT || bird.y <= 0) {
                    playSound(hitSound);
                    gameActive = false;
                    showVipEndScreen();
                }

                pipes.forEach(pipe => {
                    if (!pipe.passed && pipe.x + PIPE_WIDTH < bird.x) {
                        pipe.passed = true;
                        score += 0.5;
                        playSound(scoreSound);
                    }
                });

                // Check for pipe collision
                for (let pipe of pipes) {
                    if (bird.x < pipe.x + PIPE_WIDTH &&
                        bird.x + bird.width > pipe.x &&
                        bird.y < pipe.y + pipe.height &&
                        bird.y + bird.height > pipe.y) {
                        playSound(hitSound);
                        gameActive = false;
                        showVipEndScreen();
                    }
                }
            }

            // Draw
            ctx.clearRect(0, 0, WINDOW_WIDTH, WINDOW_HEIGHT);

            // Draw pipes
            pipes.forEach(pipe => {
                ctx.fillStyle = '#2ecc71';
                ctx.fillRect(pipe.x, pipe.y, PIPE_WIDTH, pipe.height);
                if (pipe.text && pipe.textVisible && pipe.y === 0) {
                    ctx.save();
                    ctx.fillStyle = '#FFD700';
                    ctx.font = 'bold 30px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    const textX = pipe.x + PIPE_WIDTH / 2;
                    const textY = pipe.height + PIPE_GAP / 2;
                    ctx.fillText(pipe.text, textX, textY);
                    ctx.restore();
                }
            });

            // Draw bird
            if (images.bird.complete) {
                ctx.save();
                ctx.translate(bird.x + bird.width / 2, bird.y + bird.height / 2);
                ctx.rotate(bird.velocity * 0.02);
                ctx.drawImage(images.bird, -bird.width / 2, -bird.height / 2, bird.width, bird.height);
                ctx.restore();
            } else {
                ctx.fillStyle = 'red';
                ctx.fillRect(bird.x, bird.y, bird.width, bird.height);
            }

            // Draw score
            ctx.fillStyle = 'black';
            ctx.font = '36px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`Score: ${Math.floor(score)}`, WINDOW_WIDTH / 2, 50);

            if (!gameActive) {
                ctx.fillText(`High Score: ${Math.floor(highScore)}`, WINDOW_WIDTH / 2, 100);
                ctx.font = '24px Arial';
                ctx.fillText('Press Space or Touch to Restart', WINDOW_WIDTH / 2, WINDOW_HEIGHT / 2);
            }

            requestAnimationFrame(gameTick);
        }

        // Reset game
        function resetGame() {
            gameActive = true;
            score = 0;
            bird.x = WINDOW_WIDTH * 0.25;
            bird.y = WINDOW_HEIGHT / 2;
            bird.velocity = 0;
            pipes = [];
            currentTextIndex = 0;
            gameTick();
        }

        // Show VIP end screen
        async function showVipEndScreen() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !user.name) {
                console.error('User not found in localStorage');
                window.location.href = '../index.html';
                return;
            }

            const vipScreen = document.getElementById('vipEndScreen');
            const characterAnimation = document.getElementById('characterAnimation');
            const finalScore = document.getElementById('finalScore');
            const schoolRecord = document.getElementById('schoolRecord');
            const funnyMessage = document.getElementById('funnyMessage');
            const restartButton = document.querySelector('#vipEndScreen button');

            // Disable restart button and change style
            restartButton.disabled = true;
            restartButton.style.backgroundColor = '#cccccc';
            restartButton.style.cursor = 'not-allowed';
            restartButton.textContent = '加载中...';

            // Play end sound
            const currentCharacter = images.bird.src.split('/').pop();
            if (currentCharacter === 'wzj.png') {
                playSound(sounds.endSound);
            } else if (currentCharacter === 'david.png') {
                playSound(sounds.endSound);
            }

            vipScreen.style.display = 'flex';

            // Create character animation
            const character = document.createElement('img');
            character.src = images.bird.src;
            character.style.width = '150px';
            character.style.height = '150px';
            character.style.animation = 'bounce 1s infinite';
            characterAnimation.innerHTML = '';
            characterAnimation.appendChild(character);

            // Show loading state
            schoolRecord.textContent = '正在加载最高分记录...';
            finalScore.textContent = '计算得分中...';

            try {
                // Get top score
                const topScoreResponse = await fetch('/.netlify/functions/get-top-score');
                if (!topScoreResponse.ok) {
                    throw new Error('Failed to fetch top score');
                }
                const topScoreData = await topScoreResponse.json();

                // Show top score
                schoolRecord.textContent = `校记录保持者: ${topScoreData.topPlayer} (${topScoreData.topScore}分)`;

                // Show current score after delay
                await new Promise(resolve => setTimeout(resolve, 500));
                finalScore.textContent = `最终得分: ${Math.floor(score)}`;

                // Submit score
                await fetch('/.netlify/functions/submit-game-score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: user.name,
                        score: Math.floor(score)
                    })
                });

                // Check if new record
                if (Math.floor(score) > topScoreData.topScore) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    schoolRecord.textContent = `新的记录保持者: ${user.name} (${Math.floor(score)}分)!`;
                    schoolRecord.style.color = '#FF4081';
                    schoolRecord.style.fontWeight = 'bold';
                }
                
                // 显示随机搞笑消息
                const messages = funnyMessages[currentCharacter];
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                funnyMessage.textContent = randomMessage;
                
                // 启用重启按钮
                restartButton.disabled = false;
                restartButton.style.backgroundColor = '#4CAF50';
                restartButton.style.cursor = 'pointer';
                restartButton.textContent = '再来一局';
                
            } catch (error) {
                console.error('Error:', error);
                schoolRecord.textContent = '无法获取校记录信息';
                finalScore.textContent = `最终得分: ${Math.floor(score)}`;
                funnyMessage.textContent = '发生错误，请稍后再试';
                
                // 即使出错也启用重启按钮
                restartButton.disabled = false;
                restartButton.style.backgroundColor = '#4CAF50';
                restartButton.style.cursor = 'pointer';
                restartButton.textContent = '再来一局';
            }
        }

        // 添加重启游戏函数
        function restartGame() {
            // 直接重新加载页面
            window.location.reload();
        }

        // 修改 checkCollision 函数中的游戏结束逻辑
        function checkCollision() {
            if (bird.y <= 0 || bird.y + bird.height >= WINDOW_HEIGHT) {
                playSound(hitSound);
                gameActive = false;
                showVipEndScreen();
                return false;
            }

            for (let pipe of pipes) {
                if (bird.x < pipe.x + pipe.width &&
                    bird.x + bird.width > pipe.x &&
                    bird.y < pipe.y + pipe.height &&
                    bird.y + bird.height > pipe.y) {
                    playSound(hitSound);
                    gameActive = false;
                    showVipEndScreen();
                    return false;
                }
            }
            return true;
        }

        function drawBird() {
            if (imageLoaded) {
                ctx.save();
                ctx.translate(bird.x + bird.width / 2, bird.y + bird.height / 2);
                ctx.rotate(birdMovement * 0.02);

                // 开始裁剪路径
                ctx.beginPath();
                
                // 制椭圆
                ctx.ellipse(
                    0,              // 中心点x
                    0,              // 中心点y
                    bird.width/2,   // 横向半径
                    bird.height/2,  // 纵向半径
                    0,              // 旋转角度
                    0,              // 起始角度
                    Math.PI * 2     // 结束角度
                );
                
                // 应用裁剪
                ctx.clip();

                // 绘制原始图片
                ctx.drawImage(
                    birdImage,
                    -bird.width / 2,
                    -bird.height / 2,
                    bird.width,
                    bird.height
                );
                
                ctx.restore();
            } else {
                ctx.fillStyle = 'red';
                ctx.fillRect(bird.x, bird.y, bird.width, bird.height);
            }
        }

        function drawScore() {
            ctx.fillStyle = 'black';
            ctx.font = '36px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`Score: ${Math.floor(score)}`, WINDOW_WIDTH/2, 50);
            
            if (!gameActive) {
                ctx.fillText(`High Score: ${highScore}`, WINDOW_WIDTH/2, 100);
                ctx.font = '24px Arial';
                ctx.fillText('Press Space or Touch to Restart', WINDOW_WIDTH/2, WINDOW_HEIGHT/2);
            }
        }

        function gameLoop() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, WINDOW_WIDTH, WINDOW_HEIGHT);

            if (gameActive) {
                birdMovement += GRAVITY;
                bird.y += birdMovement;

                pipes.forEach(pipe => {
                    pipe.x -= 2;
                });

                pipes = pipes.filter(pipe => pipe.x > -PIPE_WIDTH);

                if (pipes.length === 0 || pipes[pipes.length - 2].x < WINDOW_WIDTH - 300) {
                    createPipe();
                }

                pipes.forEach(pipe => {
                    if (!pipe.passed && pipe.x + pipe.width < bird.x) {
                        pipe.passed = true;
                        score += 0.5;
                        playSound(scoreSound);
                    }
                });

                gameActive = checkCollision();

                drawPipes();
                drawBird();
            } else {
                if (score > highScore) {
                    highScore = Math.floor(score);
                }
            }

            drawScore();
            requestAnimationFrame(gameLoop);
        }

        // Add touch/click controls
        function handleJump() {
            if (gameActive) {
                birdMovement = -7;
                playSound(currentFlapSound); // 使用当前角色的拍打音效
            } else {
                gameActive = true;
                pipes = [];
                bird.y = WINDOW_HEIGHT / 2;
                birdMovement = 0;
                score = 0;
            }
        }

        // Event listeners for multiple control methods
        document.addEventListener('keydown', (event) => {
            if (event.code === 'Space') {
                handleJump();
                event.preventDefault(); // Prevent page scrolling
            }
        });

        // Touch controls
        canvas.addEventListener('touchstart', (event) => {
            handleJump();
            event.preventDefault(); // Prevent default touch behaviors
        });

        // Mouse controls
        canvas.addEventListener('click', (event) => {
            handleJump();
            event.preventDefault();
        });

        // Start game function
        function startGame() {
            imageLoaded = true;
            resizeGame(); // 初始化尺寸
            gameActive = true;
            score = 0;
            pipes = [];
            birdMovement = 0;
            gameLoop();
        }

        // Don't start game loop immediately - wait for image or error

        // Initialize sounds when page loads
        preloadSounds();

        // 修改resize处理函数
        function resizeGame() {
            // 获取窗口宽度，但限制最大宽度
            const maxWidth = 600;
            WINDOW_WIDTH = Math.min(window.innerWidth - 20, maxWidth);
            WINDOW_HEIGHT = WINDOW_WIDTH * 1.5;
            
            // 更新canvas尺寸
            canvas.width = WINDOW_WIDTH;
            canvas.height = WINDOW_HEIGHT;
            
            // 更新游戏参数
            PIPE_WIDTH = WINDOW_WIDTH * 0.125;
            PIPE_GAP = WINDOW_HEIGHT * 0.25;    // 水管间隙为窗口高度的1/4
            BIRD_WIDTH = WINDOW_WIDTH * 0.1;
            BIRD_HEIGHT = WINDOW_HEIGHT * 0.05;
            
            // 更新鸟的位置和大小
            bird.width = BIRD_WIDTH;
            bird.height = BIRD_HEIGHT;
            bird.x = WINDOW_WIDTH * 0.25;
            
            // 如果是初始化，设置鸟的初始Y位置
            if (bird.y === 0) {
                bird.y = WINDOW_HEIGHT / 2;
            }
        }

        // 添加窗口resize事件监听
        window.addEventListener('resize', resizeGame);

        // 确保在页面加载完成后初始化
        window.addEventListener('load', () => {
            resizeGame();
            preloadSounds();
        });

        // 添加动画样式
        const styleSheet = document.createElement('style');
        styleSheet.textContent = `
            @keyframes bounce {
                0%, 100% { transform: translateY(0) rotate(0deg); }
                50% { transform: translateY(-20px) rotate(10deg); }
            }
        `;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>

